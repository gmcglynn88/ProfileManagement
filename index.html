<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - User & Role Manager</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:0;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
    }

    .container{
      max-width:1400px;
      margin:0 auto;
      padding:0 20px;
    }
    
    header{
      background:var(--card-bg);border-radius:12px;padding:28px 36px;
      margin-bottom:28px;box-shadow:0 2px 8px rgba(0,0,0,.08);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
      margin-top:20px;
    }

    h1{color:var(--text-color);margin-bottom:12px;font-size:32px;font-weight:600;}
    .subtitle{color:var(--text-light);font-size:17px;}
    
    .main-grid{
      display:grid;
      grid-template-columns:350px 1fr;
      gap:32px;
      min-height:calc(100vh - 200px);
    }
    
    @media(max-width:1200px){
      .main-grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:14px;padding:28px;margin-bottom:20px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }

    .card h2{
      color:var(--primary-color);margin-bottom:24px;font-size:22px;
      padding-bottom:16px;border-bottom:2px solid var(--light-bg);
      display:flex;align-items:center;gap:12px;
      font-weight:600;
    }

    .form-group{margin-bottom:24px}
    label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-color);font-size:14px;}
    select,input,button{
      padding:12px;border:1px solid var(--border-color);
      border-radius:8px;background:var(--card-bg);font-size:15px;width:100%;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      font-size:15px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:14px}
    .btn-success{background:var(--success)}.btn-success:hover{background:#218838}
    .btn-secondary{background:var(--text-light)}.btn-secondary:hover{background:#5a6268}
    .btn-export{background:var(--info)}.btn-export:hover{background:#138496}
    .btn-refresh{background:var(--primary-color);width:auto;padding:12px 20px;}
    .btn-auth{background:var(--warning);color:var(--text-color);}
    .btn-auth:hover{background:#e0a800;}

    .region-selector {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .region-selector select {
      flex: 1;
      background: var(--filter-bg);
      font-weight: 600;
      border-color: var(--primary-color);
    }
    
    .client-warning {
      background: rgba(255, 193, 7, 0.1);
      border-left: 4px solid var(--warning);
      padding: 12px;
      margin: 12px 0;
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-color);
      display: none;
    }
    
    .client-warning.active {
      display: block;
    }

    .token-info {
      background: rgba(99, 171, 143, 0.05);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 12px;
      word-break: break-all;
      border: 1px solid var(--border-color);
      display: none;
    }
    
    .token-info.active {
      display: block;
    }
    
    .token-label {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 4px;
    }
    
    .token-value {
      font-family: monospace;
      background: white;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:10px;
      max-width:400px;
    }

    .status-message{
      background:white;padding:16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:20px;margin-top:24px;
    }

    .stat-card{
      background:var(--pill);border-radius:14px;padding:24px;
      border:1px solid var(--border-color);text-align:center;
      transition:all 0.3s;
    }

    .stat-card:hover{
      transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--primary-color);
    }

    .stat-value{
      font-size:38px;font-weight:700;color:var(--primary-color);
      margin:12px 0;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .stat-label{
      font-size:15px;color:var(--text-light);
      text-transform:uppercase;letter-spacing:1px;
      font-weight:600;
    }

    .table-container{
      overflow-x:auto;margin-top:24px;border-radius:10px;
      border:1px solid var(--border-color);background:var(--card-bg);
      max-height:600px;overflow-y:auto;
    }

    table{width:100%;border-collapse:collapse}
    th{
      background-color:var(--primary-color);color:white;font-weight:600;
      position:sticky;top:0;z-index:10;white-space:nowrap;padding:14px;text-align:left;
      font-size:14px;
    }
    td{padding:14px;border-bottom:1px solid var(--border-color);font-size:14px;}
    tr:hover{background-color:var(--pill)}

    .status-badge{
      display:inline-block;padding:6px 14px;border-radius:20px;
      font-size:13px;font-weight:600;text-transform:uppercase;
    }

    .role-agent{background:rgba(99,171,143,0.15);color:var(--primary-color);border:1px solid rgba(99,171,143,0.3)}
    .role-supervisor{background:rgba(255,193,7,0.15);color:#d39e00;border:1px solid rgba(255,193,7,0.3)}
    .role-admin{background:rgba(220,53,69,0.15);color:var(--danger);border:1px solid rgba(220,53,69,0.3)}
    .role-other{background:rgba(108,117,125,0.15);color:var(--text-light);border:1px solid rgba(108,117,125,0.3)}

    .search-filter-bar{
      display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;
    }
    
    .search-filter-bar input{
      flex:2;min-width:250px;
    }
    
    .search-filter-bar select{
      flex:1;min-width:150px;
    }
    
    .search-filter-bar .stats-info{
      display:flex;align-items:center;padding:0 16px;
      background:var(--filter-bg);border-radius:8px;
      font-size:14px;color:var(--text-light);
    }

    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:60px;height:60px;border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:20px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    .progress-container{
      width:100%;max-width:500px;margin:20px auto;
    }

    .progress-bar{
      height:10px;background:var(--light-bg);border-radius:5px;
      overflow:hidden;margin-top:12px;
    }

    .progress-fill{
      height:100%;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      border-radius:5px;transition:width 0.3s ease;
      width:0%;
    }

    .role-distribution{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;margin-top:20px;
    }

    .role-card{
      background:white;border-radius:10px;padding:16px;
      border:1px solid var(--border-color);text-align:center;
    }

    .role-card .role-count{
      font-size:32px;font-weight:700;color:var(--primary-color);
    }

    .role-card .role-name{
      font-size:14px;color:var(--text-light);margin-top:8px;
    }

    .last-login-status{
      font-size:12px;color:var(--text-light);
    }
    
    .login-never{color:var(--danger);}
    .login-recent{color:var(--success);}
    .login-old{color:var(--warning);}

    .tabs{
      display:flex;border-bottom:2px solid var(--border-color);
      margin-bottom:28px;background:white;border-radius:10px 10px 0 0;
    }

    .tab{
      padding:18px 28px;background:none;border:none;
      border-bottom:2px solid transparent;font-size:16px;
      font-weight:600;color:var(--text-light);cursor:pointer;
      transition:all 0.3s;flex:1;text-align:center;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{display:none;animation:fadeIn 0.3s ease}
    .tab-content.active{display:block}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    .action-buttons{
      display:flex;gap:12px;margin-top:24px;
      flex-wrap:wrap;
    }

    .action-buttons button{
      flex:1;
      min-width:120px;
    }

    @media(max-width:768px){
      body{margin:10px;}
      .card{padding:20px}
      header{padding:20px;}
      h1{font-size:28px}
      .stat-value{font-size:32px}
      .main-grid{grid-template-columns:1fr}
      .status-container{max-width:300px}
      .search-filter-bar{flex-direction:column;}
    }

    .tooltip{
      position:relative;
      display:inline-block;
      cursor:help;
      border-bottom:1px dotted var(--text-light);
    }

    .debug-section {
      margin-top: 24px;
      border-top: 1px solid var(--border-color);
      padding-top: 16px;
    }
    
    .debug-toggle {
      background: var(--text-light);
      color: white;
      padding: 6px 12px;
      font-size: 12px;
      width: auto;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div id="authContainer" style="display:none;">
    <div class="container" style="max-width:500px;margin:100px auto;">
      <div class="card">
        <h3 style="margin-top:0;">üîê Genesys Cloud Authentication</h3>
        <div class="auto-auth-message" style="text-align:center;padding:30px;">
          <div class="spinner" style="width:40px;height:40px;border-width:3px;margin:0 auto;"></div>
          <p style="margin-top:20px;font-size:15px;color:var(--text-light);">Attempting automatic authentication...</p>
          <p style="font-size:13px;color:var(--text-light);" id="authDebugInfo"></p>
        </div>
        <button id="btnForceAuth" class="btn btn-auth btn-block" style="display:none;">üîë Force Authentication</button>
      </div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <div id="mainContent" style="display:none;">
    <div class="container">
      <header>
        <h1>üë• Genesys Cloud - User & Role Manager</h1>
        <div class="subtitle">View and manage users, roles, and permissions across your organization</div>
      </header>

      <div class="main-grid">
        <div class="left-column">
          <div class="card">
            <h2>üîå Connection</h2>
            
            <div class="region-selector">
              <select id="regionSelect">
                <option value="eu-west-1">üáÆüá™ Dublin (mypurecloud.ie)</option>
                <option value="eu-west-2">üá¨üáß London (euw2.pure.cloud)</option>
              </select>
              <button id="btnSwitchRegion" class="btn-refresh">Switch</button>
            </div>
            
            <div class="form-group">
              <label>Client ID</label>
              <select id="clientIdSelect">
                <optgroup label="üáÆüá™ Dublin Clients">
                  <option value="fe305808-b368-4547-8af9-325d28d552bb">IPIDEV (Dublin)</option>
                </optgroup>
                <optgroup label="üá¨üáß London Clients">
                  <option value="d968eca4-cdb7-4b90-91b1-4628b5bb679e">Group CX3 (London)</option>
                  <option value="a236ffec-2893-4ccd-81bb-ef2f4a2fe316">Group CX1 (London)</option>
                  <option value="cd8f1ea1-d322-4b0c-9d0c-bc9aecd13aad">JLA Group (London)</option>
                </optgroup>
              </select>
            </div>
            
            <div class="form-group">
              <label>Environment</label>
              <input type="text" id="envDisplay" value="Select environment..." readonly style="background:var(--filter-bg);">
            </div>
            
            <div class="form-group">
              <label>Status</label>
              <div style="display:flex;align-items:center;gap:10px;">
                <div id="statusIndicator" style="width:14px;height:14px;border-radius:50%;background:#6c757d;"></div>
                <span id="statusText">Not Connected</span>
              </div>
            </div>

            <div id="regionWarning" class="client-warning">
              ‚ö†Ô∏è Warning: Client ID may not work in the selected region.
            </div>

            <div id="tokenInfo" class="token-info">
              <div class="token-label">üîë Token Status</div>
              <div id="tokenStatus">No token</div>
              <div id="tokenExpiry"></div>
              <div class="token-value" id="tokenPreview"></div>
            </div>
            
            <div class="action-buttons">
              <button id="btnDisconnect" style="background:var(--danger);flex:1;">
                <span>üö™ Disconnect</span>
              </button>
              <button id="btnReauth" style="background:var(--warning);color:var(--text-color);flex:1;">
                <span>üîÑ Re-authenticate</span>
              </button>
            </div>
          </div>

          <div class="card">
            <h2>üìä User Statistics</h2>
            <div class="stats-grid" style="grid-template-columns:1fr 1fr;">
              <div class="stat-card" style="padding:16px;">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="statTotalUsers" style="font-size:28px;">0</div>
              </div>
              <div class="stat-card" style="padding:16px;">
                <div class="stat-label">With Login</div>
                <div class="stat-value" id="statActiveUsers" style="font-size:28px;">0</div>
              </div>
            </div>

            <div class="role-distribution">
              <div class="role-card">
                <div class="role-count" id="statAgents">0</div>
                <div class="role-name">Agents</div>
              </div>
              <div class="role-card">
                <div class="role-count" id="statSupervisors">0</div>
                <div class="role-name">Supervisors</div>
              </div>
              <div class="role-card">
                <div class="role-count" id="statAdmins">0</div>
                <div class="role-name">Admins</div>
              </div>
              <div class="role-card">
                <div class="role-count" id="statOthers">0</div>
                <div class="role-name">Other</div>
              </div>
            </div>

            <div style="margin-top:24px;font-size:13px;color:var(--text-light);padding:12px;background:var(--pill);border-radius:8px;">
              <strong>üìã Summary</strong><br>
              <span id="totalRolesSummary">Loading user data...</span>
            </div>
          </div>

          <div class="card">
            <h2>‚ö° Actions</h2>
            <div class="action-buttons">
              <button id="btnFetchUsers" class="btn btn-success" style="flex:2;" disabled>
                <span>üîÑ Load Users</span>
              </button>
              <button id="btnExportUsers" class="btn btn-export" style="flex:1;" disabled>
                <span>üì• Export</span>
              </button>
            </div>
            <div style="height:12px;"></div>
            <button id="btnReset" class="btn btn-block" style="background:var(--danger);">
              <span>üîÑ Reset Session</span>
            </button>
            <div style="margin-top:20px;font-size:12px;color:var(--text-light);text-align:center;">
              Last updated: <span id="lastUpdated">Never</span>
            </div>
          </div>
        </div>

        <div class="right-column">
          <div class="tabs">
            <button class="tab active" data-tab="users">üë• Users</button>
            <button class="tab" data-tab="roles">üîë Roles</button>
            <button class="tab" data-tab="logs">üìù Logs</button>
          </div>

          <div id="tab-users" class="tab-content active">
            <div class="card">
              <div class="search-filter-bar">
                <input type="text" id="userSearch" placeholder="üîç Search by name, email, team, role...">
                <select id="userFilter">
                  <option value="all">All Users</option>
                  <option value="agent">Agents Only</option>
                  <option value="supervisor">Supervisors Only</option>
                  <option value="admin">Admins Only</option>
                  <option value="other">Other Roles</option>
                  <option value="hasLogin">Has Logged In</option>
                  <option value="noLogin">Never Logged In</option>
                </select>
                <div class="stats-info">
                  <span id="visibleCount">0</span>/<span id="totalCount">0</span>
                </div>
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Team/Group</th>
                      <th>Role Type</th>
                      <th>Roles</th>
                      <th>Last Login</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
                      Click "Load Users" to fetch data
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="tab-roles" class="tab-content">
            <div class="card">
              <h2 style="margin-top:0;">üîë Role Distribution</h2>
              
              <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(250px,1fr));">
                <div class="stat-card">
                  <div class="stat-label">Unique Roles</div>
                  <div class="stat-value" id="statUniqueRoles">0</div>
                  <div class="stat-subtitle">Distinct role names</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Avg Roles/User</div>
                  <div class="stat-value" id="statAvgRoles">0</div>
                  <div class="stat-subtitle">Average per user</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Multi-Role Users</div>
                  <div class="stat-value" id="statMultiRole">0</div>
                  <div class="stat-subtitle">Users with 2+ roles</div>
                </div>
              </div>

              <div style="margin-top:32px;">
                <h3>üìã All Roles</h3>
                <div class="table-container" style="max-height:400px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Role Name</th>
                        <th>User Count</th>
                        <th>Percentage</th>
                        <th>Sample Users</th>
                      </tr>
                    </thead>
                    <tbody id="rolesTableBody">
                      <tr><td colspan="4" style="text-align:center;padding:48px;">Load users to see role data</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-logs" class="tab-content">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <h2 style="margin:0;">üìù System Logs</h2>
                <div>
                  <button id="btnClearLogs" class="btn" style="padding:10px 18px;">Clear</button>
                  <button id="btnCopyLogs" class="btn" style="padding:10px 18px;">Copy</button>
                </div>
              </div>

              <div class="table-container" style="max-height:500px;">
                <table>
                  <thead>
                    <tr>
                      <th width="120">Time</th>
                      <th width="100">Level</th>
                      <th>Message</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr><td colspan="4" style="text-align:center;padding:24px;">System initialised</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:20px;font-weight:600;margin-bottom:12px;">Loading Users...</div>
    <div id="loadingSubtext" style="font-size:15px;color:var(--text-light);text-align:center;max-width:500px;"></div>
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const CLIENT_IDS = {
      'dublin_ipidev': 'fe305808-b368-4547-8af9-325d28d552bb',
      'london_cx3': 'd968eca4-cdb7-4b90-91b1-4628b5bb679e',
      'london_cx1': 'a236ffec-2893-4ccd-81bb-ef2f4a2fe316',
      'london_JLA': 'cd8f1ea1-d322-4b0c-9d0c-bc9aecd13aad'
    };
    
    const CLIENT_REGION_MAP = {
      [CLIENT_IDS.dublin_ipidev]: 'eu-west-1',
      [CLIENT_IDS.london_cx3]: 'eu-west-2',
      [CLIENT_IDS.london_cx1]: 'eu-west-2',
      [CLIENT_IDS.london_JLA]: 'eu-west-2'
    };
    
    const REGION_DEFAULT_CLIENT = {
      'eu-west-1': CLIENT_IDS.dublin_ipidev,
      'eu-west-2': CLIENT_IDS.london_cx3
    };
    
    let CLIENT_ID = CLIENT_IDS.dublin_ipidev;
    
    // IMPORTANT: Update this to your new app's URL
    const REDIRECT_URI = 'https://gmcglynn88.github.io/ProfileManagement/'; // Update this for your new app
    
    const ENVIRONMENTS = {
      'eu-west-1': { 
        name: 'üáÆüá™ Dublin - mypurecloud.ie', 
        api: 'https://api.mypurecloud.ie', 
        login: 'https://login.mypurecloud.ie' 
      },
      'eu-west-2': { 
        name: 'üá¨üáß London - euw2.pure.cloud', 
        api: 'https://api.euw2.pure.cloud', 
        login: 'https://login.euw2.pure.cloud' 
      }
    };

    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_users_environment',
      ENV_REGION: 'gc_users_env_region',
      TOKEN: 'gc_users_token',
      TOKEN_EXPIRY: 'gc_users_token_expiry',
      REFRESH_TOKEN: 'gc_users_refresh_token',
      CLIENT_ID: 'gc_users_client_id',
      SELECTED_REGION: 'gc_users_selected_region'
    };

    let CURRENT_CONFIG = {
      environment: '',
      environmentRegion: '',
      token: null,
      tokenExpiry: null,
      refreshToken: null
    };

    let appState = {
      isConnected: false,
      userData: [],
      currentTab: 'users',
      logs: [],
      rolesCache: new Map()
    };

    // ==================== DOM ELEMENTS ====================
    const el = {
      authContainer: document.getElementById('authContainer'),
      mainContent: document.getElementById('mainContent'),
      statusContainer: document.getElementById('statusContainer'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      
      btnDisconnect: document.getElementById('btnDisconnect'),
      btnReauth: document.getElementById('btnReauth'),
      btnSwitchRegion: document.getElementById('btnSwitchRegion'),
      btnFetchUsers: document.getElementById('btnFetchUsers'),
      btnExportUsers: document.getElementById('btnExportUsers'),
      btnReset: document.getElementById('btnReset'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      btnCopyLogs: document.getElementById('btnCopyLogs'),
      btnForceAuth: document.getElementById('btnForceAuth'),
      
      regionSelect: document.getElementById('regionSelect'),
      clientIdSelect: document.getElementById('clientIdSelect'),
      regionWarning: document.getElementById('regionWarning'),
      envDisplay: document.getElementById('envDisplay'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      tokenInfo: document.getElementById('tokenInfo'),
      tokenStatus: document.getElementById('tokenStatus'),
      tokenExpiry: document.getElementById('tokenExpiry'),
      tokenPreview: document.getElementById('tokenPreview'),
      authDebugInfo: document.getElementById('authDebugInfo'),
      
      statTotalUsers: document.getElementById('statTotalUsers'),
      statActiveUsers: document.getElementById('statActiveUsers'),
      statAgents: document.getElementById('statAgents'),
      statSupervisors: document.getElementById('statSupervisors'),
      statAdmins: document.getElementById('statAdmins'),
      statOthers: document.getElementById('statOthers'),
      statUniqueRoles: document.getElementById('statUniqueRoles'),
      statAvgRoles: document.getElementById('statAvgRoles'),
      statMultiRole: document.getElementById('statMultiRole'),
      totalRolesSummary: document.getElementById('totalRolesSummary'),
      lastUpdated: document.getElementById('lastUpdated'),
      
      userSearch: document.getElementById('userSearch'),
      userFilter: document.getElementById('userFilter'),
      usersTableBody: document.getElementById('usersTableBody'),
      rolesTableBody: document.getElementById('rolesTableBody'),
      logsTableBody: document.getElementById('logsTableBody'),
      visibleCount: document.getElementById('visibleCount'),
      totalCount: document.getElementById('totalCount')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function formatDateForDisplay(dateString) {
      if (!dateString) return 'Never';
      const date = new Date(dateString);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays/7)} weeks ago`;
      
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }

    function getLoginStatusClass(lastLogin) {
      if (!lastLogin) return 'login-never';
      const date = new Date(lastLogin);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diffDays <= 7) return 'login-recent';
      if (diffDays <= 30) return 'login-old';
      return 'login-never';
    }

    function updateTokenDisplay() {
      if (CURRENT_CONFIG.token) {
        el.tokenInfo.classList.add('active');
        const expiryDate = new Date(CURRENT_CONFIG.tokenExpiry);
        const now = new Date();
        const expiresIn = Math.floor((CURRENT_CONFIG.tokenExpiry - now) / 1000 / 60);
        
        el.tokenStatus.innerHTML = expiresIn > 0 
          ? `‚úÖ Valid (expires in ${expiresIn} minutes)` 
          : `‚ùå Expired`;
        el.tokenExpiry.innerHTML = `Expires: ${expiryDate.toLocaleString()}`;
        el.tokenPreview.innerHTML = CURRENT_CONFIG.token.substring(0, 20) + '...';
      } else {
        el.tokenInfo.classList.remove('active');
      }
    }

    // ==================== AUTHENTICATION ====================
    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        const envRegion = localStorage.getItem(STORAGE_KEYS.ENV_REGION);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
        const storedClientId = localStorage.getItem(STORAGE_KEYS.CLIENT_ID);
        const storedRegion = localStorage.getItem(STORAGE_KEYS.SELECTED_REGION);

        logMessage('DEBUG', 'Loading stored credentials', {
          hasToken: !!token,
          envRegion,
          storedRegion,
          storedClientId: storedClientId?.substring(0,8)
        });

        if (storedRegion) {
          const options = Array.from(el.regionSelect.options);
          if (options.some(opt => opt.value === storedRegion)) {
            el.regionSelect.value = storedRegion;
          }
        }

        if (storedClientId) {
          CLIENT_ID = storedClientId;
          const options = Array.from(el.clientIdSelect.options);
          for (let i = 0; i < options.length; i++) {
            if (options[i].value === storedClientId) {
              options[i].selected = true;
              break;
            }
          }
        }

        if (token && tokenExpiry && environment && envRegion) {
          CURRENT_CONFIG = {
            token,
            tokenExpiry: parseInt(tokenExpiry, 10),
            environment,
            environmentRegion: envRegion,
            refreshToken
          };

          // Check if token is still valid
          if (Date.now() < CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
            if (!storedRegion || envRegion === storedRegion) {
              logMessage('SUCCESS', 'Valid stored token found', `Expires: ${new Date(parseInt(tokenExpiry, 10)).toLocaleString()}`);
              return true;
            } else {
              logMessage('WARN', 'Token region mismatch', `Token: ${envRegion}, Selected: ${storedRegion}`);
            }
          } else {
            logMessage('WARN', 'Stored token expired', `Expired: ${new Date(parseInt(tokenExpiry, 10)).toLocaleString()}`);
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
        logMessage('ERROR', 'Failed to load credentials', e.message);
      }
      return false;
    }

    function saveCredentials(token, expiresIn, environment, envRegion, refreshToken = null) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        CURRENT_CONFIG = { token, tokenExpiry, environment, environmentRegion: envRegion, refreshToken };
        
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);
        localStorage.setItem(STORAGE_KEYS.ENV_REGION, envRegion);
        if (refreshToken) localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
        localStorage.setItem(STORAGE_KEYS.SELECTED_REGION, envRegion);
        localStorage.setItem(STORAGE_KEYS.CLIENT_ID, CLIENT_ID);
        
        updateTokenDisplay();
        logMessage('SUCCESS', 'Credentials saved', `Region: ${envRegion}, Expires: ${new Date(tokenExpiry).toLocaleString()}`);
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        logMessage('ERROR', 'Failed to save credentials', e.message);
        return false;
      }
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.ENV_REGION);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        // Keep SELECTED_REGION and CLIENT_ID
        
        CURRENT_CONFIG = { 
          environment: '', 
          environmentRegion: '', 
          token: null, 
          tokenExpiry: null, 
          refreshToken: null 
        };
        
        updateTokenDisplay();
        logMessage('INFO', 'Credentials cleared');
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    async function attemptTokenRefresh() {
      if (!CURRENT_CONFIG.refreshToken || !CURRENT_CONFIG.environment || !CURRENT_CONFIG.environmentRegion) {
        logMessage('DEBUG', 'Cannot refresh - missing refresh token or environment');
        return false;
      }
      
      try {
        const loginUrl = ENVIRONMENTS[CURRENT_CONFIG.environmentRegion]?.login;
        if (!loginUrl) return false;

        logMessage('INFO', 'Attempting token refresh', `Region: ${CURRENT_CONFIG.environmentRegion}`);

        const response = await fetch(`${loginUrl}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${CLIENT_ID}:`)
          },
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: CURRENT_CONFIG.refreshToken
          })
        });

        if (response.ok) {
          const data = await response.json();
          saveCredentials(data.access_token, data.expires_in, CURRENT_CONFIG.environment, 
                         CURRENT_CONFIG.environmentRegion, data.refresh_token || CURRENT_CONFIG.refreshToken);
          logMessage('SUCCESS', 'Token refreshed successfully');
          return true;
        } else {
          const error = await response.text();
          logMessage('ERROR', 'Token refresh failed', `Status: ${response.status}, Error: ${error}`);
          return false;
        }
      } catch (error) {
        console.warn('Token refresh failed:', error);
        logMessage('ERROR', 'Token refresh exception', error.message);
        return false;
      }
    }

    function parseTokenFromHash() {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return {};
      
      const params = new URLSearchParams(hash);
      const result = {
        token: params.get('access_token'),
        refreshToken: params.get('refresh_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in'),
        state: params.get('state')
      };
      
      logMessage('DEBUG', 'Parsed token from hash', {
        hasToken: !!result.token,
        hasError: !!result.error,
        expiresIn: result.expiresIn
      });
      
      return result;
    }

    function parseEnvironmentFromState(state) {
      if (!state) {
        const stored = localStorage.getItem(STORAGE_KEYS.SELECTED_REGION) || 'eu-west-1';
        logMessage('DEBUG', 'No state, using stored region', stored);
        return stored;
      }
      try {
        const stateObj = JSON.parse(atob(state));
        return stateObj.env || localStorage.getItem(STORAGE_KEYS.SELECTED_REGION) || 'eu-west-1';
      } catch (e) {
        logMessage('WARN', 'Failed to parse state', e.message);
        return localStorage.getItem(STORAGE_KEYS.SELECTED_REGION) || 'eu-west-1';
      }
    }

    function authUrl(envRegion) {
      const env = ENVIRONMENTS[envRegion];
      if (!env) return null;
      
      const state = btoa(JSON.stringify({ 
        env: envRegion,
        ts: Date.now(),
        client: CLIENT_ID.substring(0,8)
      }));
      
      const url = `${env.login}/oauth/authorize?client_id=${encodeURIComponent(CLIENT_ID)}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${encodeURIComponent(state)}`;
      
      logMessage('INFO', 'Generated auth URL', {
        region: envRegion,
        client: CLIENT_ID.substring(0,8),
        loginUrl: env.login
      });
      
      return url;
    }

    async function initAuth() {
      el.authContainer.style.display = 'block';
      if (el.authDebugInfo) {
        el.authDebugInfo.innerHTML = 'Checking for existing authentication...';
      }
      
      const { token, refreshToken, error, errorDescription, expiresIn, state } = parseTokenFromHash();
      
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }

      if (token) {
        logMessage('INFO', 'Token found in URL', 'Processing authentication');
        const envRegion = parseEnvironmentFromState(state);
        const env = ENVIRONMENTS[envRegion];
        
        if (env) {
          el.regionSelect.value = envRegion;
          
          // Ensure we're using a client ID for this region
          if (CLIENT_REGION_MAP[CLIENT_ID] !== envRegion) {
            const defaultClient = REGION_DEFAULT_CLIENT[envRegion];
            if (defaultClient) {
              CLIENT_ID = defaultClient;
              // Update dropdown
              const options = Array.from(el.clientIdSelect.options);
              for (let i = 0; i < options.length; i++) {
                if (options[i].value === defaultClient) {
                  options[i].selected = true;
                  break;
                }
              }
            }
          }
          
          if (saveCredentials(token, expiresIn || '3600', env.api, envRegion, refreshToken)) {
            logMessage('SUCCESS', 'Authentication successful', `Connected to ${env.name}`);
            showStatusMessage('‚úÖ Connected to Genesys Cloud', 'success');
            showMainApp(env.name);
            return;
          }
        }
      }

      if (error) {
        logMessage('ERROR', 'Authentication failed', `${error}: ${errorDescription}`);
        showStatusMessage(`‚ùå Authentication failed: ${error}`, 'error');
        if (el.authDebugInfo) {
          el.authDebugInfo.innerHTML = `‚ùå Auth failed: ${error} - ${errorDescription}`;
          el.btnForceAuth.style.display = 'block';
        }
        return;
      }

      const hasValidToken = loadStoredCredentials();
      if (hasValidToken) {
        const envName = ENVIRONMENTS[CURRENT_CONFIG.environmentRegion]?.name || 'Genesys Cloud';
        logMessage('SUCCESS', 'Auto-authentication successful', 'Using stored credentials');
        if (el.authDebugInfo) {
          el.authDebugInfo.innerHTML = '‚úÖ Using stored credentials';
        }
        setTimeout(() => showMainApp(envName), 500);
        return;
      }

      const refreshSuccess = await attemptTokenRefresh();
      if (refreshSuccess) {
        const envName = ENVIRONMENTS[CURRENT_CONFIG.environmentRegion]?.name || 'Genesys Cloud';
        logMessage('SUCCESS', 'Token refreshed', 'Auto-authentication successful');
        if (el.authDebugInfo) {
          el.authDebugInfo.innerHTML = '‚úÖ Token refreshed';
        }
        setTimeout(() => showMainApp(envName), 500);
        return;
      }

      logMessage('INFO', 'No valid credentials found', 'Redirecting to authentication...');
      if (el.authDebugInfo) {
        el.authDebugInfo.innerHTML = '‚è≥ No valid credentials, redirecting to login...';
      }
      setTimeout(() => authenticate(), 1500);
    }

    function authenticate() {
      const envRegion = el.regionSelect.value;
      const env = ENVIRONMENTS[envRegion];
      
      if (!env) {
        logMessage('ERROR', 'Invalid environment selected');
        return;
      }
      
      // Save the selected region and client before redirect
      localStorage.setItem(STORAGE_KEYS.SELECTED_REGION, envRegion);
      localStorage.setItem(STORAGE_KEYS.CLIENT_ID, CLIENT_ID);
      
      const authUrlValue = authUrl(envRegion);
      if (authUrlValue) {
        logMessage('INFO', 'Redirecting to authentication', `Region: ${env.name}, Client: ${CLIENT_ID.substring(0,8)}`);
        window.location.href = authUrlValue;
      } else {
        logMessage('ERROR', 'Could not generate authentication URL');
      }
    }

    function checkTokenExpiry() {
      if (!CURRENT_CONFIG.token || !CURRENT_CONFIG.tokenExpiry) {
        logMessage('DEBUG', 'No token to check expiry');
        return false;
      }
      
      const now = Date.now();
      const expiresIn = CURRENT_CONFIG.tokenExpiry - now;
      const expiresInMinutes = Math.floor(expiresIn / 1000 / 60);
      
      logMessage('DEBUG', 'Token expiry check', `Expires in ${expiresInMinutes} minutes`);
      
      if (expiresIn < 0) {
        logMessage('WARN', 'Token expired');
        return false;
      }
      
      if (expiresIn < (5 * 60 * 1000)) {
        logMessage('WARN', `Token expires in ${expiresInMinutes} minutes`);
      }
      
      return expiresIn > 0;
    }

    function showMainApp(environmentName) {
      el.authContainer.style.display = 'none';
      el.mainContent.style.display = 'block';
      el.envDisplay.value = environmentName || 'Genesys Cloud';
      updateConnectionStatus(true, 'Connected ‚úì');
      
      if (CURRENT_CONFIG.environmentRegion) {
        el.regionSelect.value = CURRENT_CONFIG.environmentRegion;
      }
      
      updateTokenDisplay();
      initializeApp();
    }

    function disconnect() {
      if (confirm('Disconnect from Genesys Cloud? This will clear all stored credentials.')) {
        clearCredentials();
        appState.userData = [];
        appState.rolesCache.clear();
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        logMessage('INFO', 'Disconnected from Genesys Cloud');
        if (el.authDebugInfo) {
          el.authDebugInfo.innerHTML = 'Disconnected. Ready to authenticate...';
        }
      }
    }

    function reauthenticate() {
      if (confirm('Re-authenticate? This will clear your current session.')) {
        clearCredentials();
        appState.userData = [];
        appState.rolesCache.clear();
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        if (el.authDebugInfo) {
          el.authDebugInfo.innerHTML = 'Re-authenticating...';
        }
        setTimeout(() => authenticate(), 500);
      }
    }

    function switchRegion() {
      const selectedRegion = el.regionSelect.value;
      const previousRegion = CURRENT_CONFIG.environmentRegion;
      
      if (selectedRegion === previousRegion) {
        showStatusMessage('Already using this region', 'info');
        return;
      }
      
      if (confirm('Switch region? This will disconnect your current session and require a new login.')) {
        localStorage.setItem(STORAGE_KEYS.SELECTED_REGION, selectedRegion);
        
        // Set default client for the new region
        const defaultClient = REGION_DEFAULT_CLIENT[selectedRegion];
        if (defaultClient) {
          CLIENT_ID = defaultClient;
          localStorage.setItem(STORAGE_KEYS.CLIENT_ID, CLIENT_ID);
          
          // Update dropdown
          const options = Array.from(el.clientIdSelect.options);
          for (let i = 0; i < options.length; i++) {
            if (options[i].value === defaultClient) {
              options[i].selected = true;
              break;
            }
          }
        }
        
        clearCredentials();
        appState.userData = [];
        appState.rolesCache.clear();
        
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        
        logMessage('INFO', 'Switched region', `Now using ${ENVIRONMENTS[selectedRegion]?.name}`);
        showStatusMessage(`üîÑ Switched to ${ENVIRONMENTS[selectedRegion]?.name}`, 'info');
        setTimeout(() => authenticate(), 300);
      } else {
        // Revert dropdown if user cancels
        el.regionSelect.value = previousRegion || 'eu-west-1';
      }
    }

    function updateConnectionStatus(connected, message = '') {
      appState.isConnected = connected;
      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = message || 'Connected ‚úì';
        el.statusText.style.color = 'var(--success)';
        el.btnFetchUsers.disabled = false;
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = message || 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnFetchUsers.disabled = true;
        el.btnExportUsers.disabled = true;
      }
    }

    // ==================== API FUNCTIONS ====================
    async function apiCall(path, options = {}) {
      if (!CURRENT_CONFIG.token) {
        throw new Error('Not authenticated - no token found');
      }
      
      if (!checkTokenExpiry()) {
        logMessage('WARN', 'Token expired, attempting refresh');
        const refreshSuccess = await attemptTokenRefresh();
        if (!refreshSuccess) {
          throw new Error('Authentication token expired and refresh failed. Please reconnect.');
        }
      }
      
      const url = `${CURRENT_CONFIG.environment}${path}`;
      logMessage('DEBUG', 'API Call', `${options.method || 'GET'} ${path}`);
      
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (response.status === 401 || response.status === 403) {
          logMessage('ERROR', `Authentication error ${response.status}`, `Path: ${path}`);
          
          // Try to refresh once more
          const refreshSuccess = await attemptTokenRefresh();
          if (refreshSuccess) {
            logMessage('INFO', 'Token refreshed, retrying API call');
            // Retry with new token
            const retryResponse = await fetch(url, {
              ...options,
              headers: {
                'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
                'Content-Type': 'application/json',
                ...options.headers
              }
            });
            if (retryResponse.ok) {
              return retryResponse.json();
            }
          }
          
          throw new Error(`Authentication error (${response.status}). Please reconnect.`);
        }
        
        if (response.status === 429) {
          const retryAfter = response.headers.get('Retry-After') || 5;
          logMessage('WARN', `Rate limit exceeded`, `Retrying after ${retryAfter} seconds`);
          await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
          return apiCall(path, options);
        }
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
      } catch (error) {
        logMessage('ERROR', 'API call failed', `${path}: ${error.message}`);
        throw error;
      }
    }

    function detectUserRole(roles) {
      if (!roles || !Array.isArray(roles)) return 'other';
      const roleNames = roles.map(r => r.name.toLowerCase());
      
      const adminKeywords = ['admin', 'administrator', 'system administrator', 'org admin'];
      if (roleNames.some(role => adminKeywords.some(keyword => role.includes(keyword)))) return 'admin';
      
      const supervisorKeywords = ['supervisor', 'team lead', 'manager', 'director', 'lead'];
      if (roleNames.some(role => supervisorKeywords.some(keyword => role.includes(keyword)))) return 'supervisor';
      
      const agentKeywords = ['agent', 'user', 'employee', 'representative', 'customer service'];
      if (roleNames.some(role => agentKeywords.some(keyword => role.includes(keyword)))) return 'agent';
      
      return 'other';
    }

    // ==================== MAIN FUNCTIONS ====================
    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details: typeof details === 'object' ? JSON.stringify(details) : details };
      appState.logs.unshift(logEntry);
      
      const row = document.createElement('tr');
      const levelIcon = level === 'ERROR' ? 'üî¥' : level === 'WARN' ? 'üü°' : level === 'SUCCESS' ? '‚úÖ' : level === 'DEBUG' ? 'üîç' : 'üîµ';
      
      let detailsDisplay = typeof details === 'object' ? JSON.stringify(details).substring(0, 100) : String(details).substring(0, 100);
      if (detailsDisplay.length >= 100) detailsDisplay += '...';
      
      row.innerHTML = `<td>${timestamp}</td><td>${levelIcon} ${level}</td><td>${message}</td><td>${detailsDisplay}</td>`;
      
      if (el.logsTableBody.children[0]?.innerHTML.includes('System initialised')) {
        el.logsTableBody.innerHTML = '';
      }
      el.logsTableBody.prepend(row);
      
      if (el.logsTableBody.children.length > 100) {
        el.logsTableBody.removeChild(el.logsTableBody.lastChild);
      }
      
      if (level === 'ERROR' || level === 'SUCCESS' || level === 'WARN') {
        showStatusMessage(message, level.toLowerCase());
      }
      console.log(`[${level}] ${message}`, details);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : type === 'warn' ? 'var(--warning)' : 'var(--info)';
      
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `<span style="font-size:20px;">${icon}</span><div><div style="font-weight:600;">${message}</div><div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div></div>`;
      
      el.statusContainer.appendChild(msgDiv);
      
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    async function fetchUserData() {
      if (!appState.isConnected) {
        showStatusMessage('Please connect first', 'warn');
        return;
      }

      setLoading(true, 'Loading Users', 'Fetching user list from Genesys Cloud...');
      updateLoadingProgress(10);

      try {
        let allUsers = [];
        let page = 1;
        const pageSize = 100;

        logMessage('INFO', 'Starting user fetch', `Region: ${CURRENT_CONFIG.environmentRegion}`);

        while (true) {
          updateLoadingProgress(10 + (page * 5));
          
          logMessage('DEBUG', `Fetching page ${page}`);
          const usersData = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&expand=dateLastLogin,authorization,groups`);
          const users = usersData?.entities || [];
          allUsers = allUsers.concat(users);
          
          logMessage('INFO', `Fetched page ${page}`, `${users.length} users (total: ${allUsers.length})`);
          
          if (!usersData?.nextUri || users.length < pageSize) break;
          page++;
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        updateLoadingProgress(70);
        logMessage('SUCCESS', `Loaded ${allUsers.length} users total`);

        appState.userData = allUsers.map(user => {
          const teamName = user.groups && user.groups.length > 0 
            ? user.groups.map(g => g.name).join(', ') 
            : 'Unassigned';
          
          const roleNames = user.authorization?.roles 
            ? user.authorization.roles.map(r => r.name) 
            : [];
          
          const userType = detectUserRole(user.authorization?.roles);
          
          return {
            id: user.id,
            name: user.name || 'Unknown',
            email: user.email || 'No email',
            team: teamName,
            roles: roleNames,
            userType: userType,
            lastLogin: user.dateLastLogin,
            lastLoginDisplay: formatDateForDisplay(user.dateLastLogin),
            loginStatusClass: getLoginStatusClass(user.dateLastLogin),
            state: user.state || 'active'
          };
        });

        updateStats();
        renderUserTable();
        renderRolesTable();

        updateLoadingProgress(100);
        setLoading(false);
        
        el.btnExportUsers.disabled = false;
        el.lastUpdated.textContent = new Date().toLocaleString();
        
        logMessage('SUCCESS', 'User data loaded successfully', `${appState.userData.length} users`);
        showStatusMessage(`‚úÖ Loaded ${appState.userData.length} users`, 'success');

      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch users', error.message);
        showStatusMessage('‚ùå Failed to fetch user data', 'error');
        
        // If it's an auth error, show reconnect option
        if (error.message.includes('Authentication') || error.message.includes('401')) {
          if (confirm('Authentication failed. Would you like to reconnect?')) {
            reauthenticate();
          }
        }
      }
    }

    function updateStats() {
      const users = appState.userData;
      
      // Basic counts
      el.statTotalUsers.textContent = users.length;
      el.totalCount.textContent = users.length;
      
      const usersWithLogin = users.filter(u => u.lastLogin).length;
      el.statActiveUsers.textContent = usersWithLogin;
      
      // Role type counts
      const agents = users.filter(u => u.userType === 'agent').length;
      const supervisors = users.filter(u => u.userType === 'supervisor').length;
      const admins = users.filter(u => u.userType === 'admin').length;
      const others = users.filter(u => u.userType === 'other').length;
      
      el.statAgents.textContent = agents;
      el.statSupervisors.textContent = supervisors;
      el.statAdmins.textContent = admins;
      el.statOthers.textContent = others;
      
      // Role analysis
      const roleFrequency = new Map();
      let totalRoles = 0;
      let multiRoleCount = 0;
      
      users.forEach(user => {
        if (user.roles && user.roles.length > 0) {
          totalRoles += user.roles.length;
          if (user.roles.length > 1) multiRoleCount++;
          
          user.roles.forEach(role => {
            roleFrequency.set(role, (roleFrequency.get(role) || 0) + 1);
          });
        }
      });
      
      appState.rolesCache = roleFrequency;
      
      el.statUniqueRoles.textContent = roleFrequency.size;
      el.statAvgRoles.textContent = users.length > 0 
        ? (totalRoles / users.length).toFixed(1) 
        : '0';
      el.statMultiRole.textContent = multiRoleCount;
      
      // Summary text
      const pctWithLogin = users.length > 0 
        ? Math.round((usersWithLogin / users.length) * 100) 
        : 0;
      
      el.totalRolesSummary.innerHTML = `
        <span title="Users who have ever logged in">üìä ${usersWithLogin} users with login (${pctWithLogin}%)</span><br>
        <span title="Total roles assigned across all users">üîë ${totalRoles} total role assignments</span><br>
        <span title="Users with multiple roles">üë• ${multiRoleCount} users have 2+ roles</span>
      `;
    }

    function renderUserTable() {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';
      
      const searchTerm = el.userSearch.value.toLowerCase();
      const filterValue = el.userFilter.value;
      
      let usersToDisplay = [...appState.userData];

      // Apply filters
      if (filterValue !== 'all') {
        if (filterValue === 'agent') usersToDisplay = usersToDisplay.filter(u => u.userType === 'agent');
        else if (filterValue === 'supervisor') usersToDisplay = usersToDisplay.filter(u => u.userType === 'supervisor');
        else if (filterValue === 'admin') usersToDisplay = usersToDisplay.filter(u => u.userType === 'admin');
        else if (filterValue === 'other') usersToDisplay = usersToDisplay.filter(u => u.userType === 'other');
        else if (filterValue === 'hasLogin') usersToDisplay = usersToDisplay.filter(u => u.lastLogin);
        else if (filterValue === 'noLogin') usersToDisplay = usersToDisplay.filter(u => !u.lastLogin);
      }

      // Apply search
      if (searchTerm) {
        usersToDisplay = usersToDisplay.filter(user =>
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.team && user.team.toLowerCase().includes(searchTerm)) ||
          (user.roles && user.roles.some(r => r.toLowerCase().includes(searchTerm)))
        );
      }

      el.visibleCount.textContent = usersToDisplay.length;

      if (usersToDisplay.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
          ${appState.userData.length === 0 ? 'No data loaded. Click "Load Users" to fetch data.' : 'No users match your search/filter.'}
        </td>`;
        tbody.appendChild(row);
        return;
      }

      usersToDisplay.slice(0, 500).forEach(user => { // Limit to 500 rows for performance
        const row = document.createElement('tr');
        
        let roleTypeBadge = '';
        switch(user.userType) {
          case 'agent':
            roleTypeBadge = `<span class="status-badge role-agent">Agent</span>`;
            break;
          case 'supervisor':
            roleTypeBadge = `<span class="status-badge role-supervisor">Supervisor</span>`;
            break;
          case 'admin':
            roleTypeBadge = `<span class="status-badge role-admin">Admin</span>`;
            break;
          default:
            roleTypeBadge = `<span class="status-badge role-other">Other</span>`;
        }

        const rolesDisplay = user.roles && user.roles.length > 0
          ? user.roles.slice(0, 2).join(', ') + (user.roles.length > 2 ? ` +${user.roles.length-2}` : '')
          : 'No roles';

        const loginClass = user.loginStatusClass;
        const loginDisplay = user.lastLoginDisplay || 'Never';

        row.innerHTML = `
          <td><strong>${user.name}</strong></td>
          <td>${user.email}</td>
          <td style="font-size:13px;">${user.team}</td>
          <td>${roleTypeBadge}</td>
          <td>
            <span title="${user.roles ? user.roles.join('\n') : 'No roles'}">
              ${rolesDisplay}
            </span>
          </td>
          <td><span class="last-login-status ${loginClass}">${loginDisplay}</span></td>
          <td><span class="status-badge" style="background:rgba(99,171,143,0.1);">${user.state}</span></td>
        `;
        tbody.appendChild(row);
      });
      
      if (usersToDisplay.length > 500) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align:center;padding:12px;background:var(--filter-bg);">
          Showing first 500 of ${usersToDisplay.length} users. Refine search to see more.
        </td>`;
        tbody.appendChild(row);
      }
    }

    function renderRolesTable() {
      const tbody = el.rolesTableBody;
      tbody.innerHTML = '';
      
      if (appState.rolesCache.size === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="4" style="text-align:center;padding:48px;">Load users to see role data</td>`;
        tbody.appendChild(row);
        return;
      }

      const totalUsers = appState.userData.length;
      const sortedRoles = Array.from(appState.rolesCache.entries())
        .sort((a, b) => b[1] - a[1]);

      sortedRoles.slice(0, 200).forEach(([roleName, count]) => {
        const percentage = ((count / totalUsers) * 100).toFixed(1);
        const row = document.createElement('tr');
        
        // Find sample users with this role
        const sampleUsers = appState.userData
          .filter(u => u.roles && u.roles.includes(roleName))
          .slice(0, 3)
          .map(u => u.name)
          .join(', ');
        
        row.innerHTML = `
          <td><strong>${roleName}</strong></td>
          <td style="text-align:center;font-weight:600;">${count}</td>
          <td style="text-align:center;">${percentage}%</td>
          <td style="font-size:13px;color:var(--text-light);">${sampleUsers}${count > 3 ? '...' : ''}</td>
        `;
        tbody.appendChild(row);
      });

      if (sortedRoles.length > 200) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="4" style="text-align:center;padding:8px;background:var(--filter-bg);">
          Showing first 200 of ${sortedRoles.length} roles
        </td>`;
        tbody.appendChild(row);
      }

      // Add summary row
      const summaryRow = document.createElement('tr');
      summaryRow.style.backgroundColor = 'var(--filter-bg)';
      summaryRow.innerHTML = `
        <td><strong>TOTAL</strong></td>
        <td style="text-align:center;"><strong>${sortedRoles.reduce((sum, [_, count]) => sum + count, 0)}</strong></td>
        <td colspan="2" style="text-align:center;font-size:13px;">Total role assignments</td>
      `;
      tbody.appendChild(summaryRow);
    }

    function exportUsers() {
      if (!appState.userData || appState.userData.length === 0) {
        showStatusMessage('No user data to export', 'warn');
        return;
      }

      let csv = 'Genesys Cloud User Export\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Total Users: ${appState.userData.length}\n\n`;

      csv += 'Name,Email,Team,User Type,Roles,Last Login,State\n';

      appState.userData.forEach(user => {
        const roles = user.roles ? user.roles.join('; ') : '';
        const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
        
        csv += `"${user.name || ''}","${user.email || ''}","${user.team || ''}","${user.userType || ''}","${roles}","${lastLogin}","${user.state || 'active'}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      
      a.href = url;
      a.download = `genesys_users_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Users exported', `${appState.userData.length} users exported`);
      showStatusMessage(`‚úÖ Exported ${appState.userData.length} users to CSV`, 'success');
    }

    function resetApplication() {
      if (confirm('Reset the application? This will clear all user data but keep the connection.')) {
        appState.userData = [];
        appState.rolesCache.clear();
        
        el.statTotalUsers.textContent = '0';
        el.statActiveUsers.textContent = '0';
        el.statAgents.textContent = '0';
        el.statSupervisors.textContent = '0';
        el.statAdmins.textContent = '0';
        el.statOthers.textContent = '0';
        el.statUniqueRoles.textContent = '0';
        el.statAvgRoles.textContent = '0';
        el.statMultiRole.textContent = '0';
        el.totalCount.textContent = '0';
        el.visibleCount.textContent = '0';
        el.totalRolesSummary.innerHTML = 'No data loaded';
        el.btnExportUsers.disabled = true;
        
        el.usersTableBody.innerHTML = `
          <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
            Click "Load Users" to fetch data
          </td></tr>
        `;
        
        el.rolesTableBody.innerHTML = `
          <tr><td colspan="4" style="text-align:center;padding:48px;">Load users to see role data</td></tr>
        `;
        
        logMessage('INFO', 'Application reset', 'All user data cleared');
        showStatusMessage('üîÑ Application reset', 'info');
      }
    }

    function initializeApp() {
      logMessage('INFO', 'User Manager initialised', `Region: ${el.regionSelect.value}, Client: ${CLIENT_ID.substring(0,8)}`);
      
      // Set up event listeners
      el.btnDisconnect.addEventListener('click', disconnect);
      el.btnReauth.addEventListener('click', reauthenticate);
      el.btnSwitchRegion.addEventListener('click', switchRegion);
      el.btnFetchUsers.addEventListener('click', fetchUserData);
      el.btnExportUsers.addEventListener('click', exportUsers);
      el.btnReset.addEventListener('click', resetApplication);
      el.btnForceAuth.addEventListener('click', () => {
        el.btnForceAuth.style.display = 'none';
        authenticate();
      });

      el.userSearch.addEventListener('input', renderUserTable);
      el.userFilter.addEventListener('change', renderUserTable);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) content.classList.add('active');
          });
        });
      });

      // Log management
      el.btnClearLogs.addEventListener('click', () => {
        el.logsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;">Logs cleared</td></tr>';
        appState.logs = [];
      });

      el.btnCopyLogs.addEventListener('click', () => {
        const logText = appState.logs.map(log =>
          `${log.timestamp} [${log.level}] ${log.message} ${log.details ? '- ' + log.details : ''}`
        ).join('\n');
        navigator.clipboard.writeText(logText).then(() => 
          showStatusMessage('Logs copied to clipboard', 'success')
        );
      });

      // Client ID change handler
      el.clientIdSelect.addEventListener('change', () => {
        const newClientId = el.clientIdSelect.value;
        if (newClientId !== CLIENT_ID) {
          CLIENT_ID = newClientId;
          logMessage('INFO', 'Client ID changed', CLIENT_ID.substring(0,8));
          
          // Check region compatibility
          const clientRegion = CLIENT_REGION_MAP[CLIENT_ID];
          const selectedRegion = el.regionSelect.value;
          
          if (clientRegion && clientRegion !== selectedRegion) {
            el.regionWarning.classList.add('active');
            el.regionWarning.innerHTML = `‚ö†Ô∏è Warning: This client ID was created for ${ENVIRONMENTS[clientRegion]?.name} but you have ${ENVIRONMENTS[selectedRegion]?.name} selected.`;
          } else {
            el.regionWarning.classList.remove('active');
          }
        }
      });

      // Initial region check
      const checkClientRegionMatch = () => {
        const selectedRegion = el.regionSelect.value;
        const clientRegion = CLIENT_REGION_MAP[CLIENT_ID];
        
        if (clientRegion && clientRegion !== selectedRegion) {
          el.regionWarning.classList.add('active');
          el.regionWarning.innerHTML = `‚ö†Ô∏è Warning: This client ID was created for ${ENVIRONMENTS[clientRegion]?.name} but you have ${ENVIRONMENTS[selectedRegion]?.name} selected.`;
        } else {
          el.regionWarning.classList.remove('active');
        }
      };

      el.regionSelect.addEventListener('change', checkClientRegionMatch);
      checkClientRegionMatch();
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
