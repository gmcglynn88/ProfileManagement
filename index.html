<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - JLA User Manager</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --filter-bg:#f0f7f3; --warning:#ffc107; --danger:#dc3545;
      --success:#28a745; --info:#17a2b8;
    }

    * {
      box-sizing: border-box;
    }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:0;
      padding:20px;
      background:var(--light-bg);color:var(--text-color);
      line-height:1.6;
      height:100vh;
      overflow:hidden;
    }

    .container{
      max-width:100%;
      height:100%;
      margin:0 auto;
      padding:0 20px;
      display:flex;
      flex-direction:column;
    }
    
    header{
      background:var(--card-bg);border-radius:12px;padding:20px 36px;
      margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);
      border-left:5px solid var(--primary-color);border:1px solid var(--border-color);
      flex-shrink:0;
    }

    h1{
      color:var(--text-color);
      margin:0 0 8px 0;
      font-size:28px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .subtitle{
      color:var(--text-light);
      font-size:15px;
      margin:0;
    }
    
    .main-grid{
      display:grid;
      grid-template-columns:350px 1fr;
      gap:20px;
      flex:1;
      min-height:0; /* Critical for nested flex/grid children */
    }
    
    @media(max-width:1200px){
      .main-grid{grid-template-columns:1fr}
    }

    .left-column, .right-column {
      display:flex;
      flex-direction:column;
      gap:20px;
      min-height:0;
      height:100%;
      overflow:hidden;
    }

    .card{
      background:var(--card-bg);border:1px solid var(--border-color);
      border-radius:14px;padding:20px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
    }

    .card.fill-height {
      flex:1;
      min-height:0;
      overflow:hidden;
    }

    .card h2{
      color:var(--primary-color);
      margin:0 0 16px 0;
      font-size:20px;
      padding-bottom:12px;
      border-bottom:2px solid var(--light-bg);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:600;
      flex-shrink:0;
    }

    .form-group{margin-bottom:16px}
    label{display:block;font-weight:600;margin-bottom:6px;color:var(--text-color);font-size:13px;}
    select,input,button{
      padding:10px 12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background:var(--card-bg);
      font-size:14px;
      width:100%;
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
    }

    button{
      background:var(--primary-color);color:#fff;font-weight:600;
      cursor:pointer;transition:background .2s;border:none;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      font-size:14px;
    }

    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .btn-block{width:100%;padding:12px}
    .btn-success{background:var(--success)}.btn-success:hover{background:#218838}
    .btn-secondary{background:var(--text-light)}.btn-secondary:hover{background:#5a6268}
    .btn-export{background:var(--info)}.btn-export:hover{background:#138496}
    .btn-small{padding:6px 12px;font-size:12px;width:auto;}

    .region-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .region-selector select {
      flex: 1;
      background: var(--filter-bg);
      font-weight: 600;
      border-color: var(--primary-color);
    }

    .jla-badge {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .token-info {
      background: rgba(99, 171, 143, 0.05);
      border-radius: 8px;
      padding: 10px;
      margin-top: 12px;
      font-size: 12px;
      word-break: break-all;
      border: 1px solid var(--border-color);
      display: none;
    }
    
    .token-info.active { display: block; }
    
    .token-label {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 4px;
    }
    
    .token-value {
      font-family: monospace;
      background: white;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      font-size: 11px;
    }

    .status-container{
      position:fixed;top:20px;right:20px;z-index:1000;
      display:flex;flex-direction:column;gap:8px;
      max-width:350px;
    }

    .status-message{
      background:white;padding:12px 16px;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary-color);
      animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px;
    }

    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }

    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:12px;
      margin-bottom:16px;
    }

    .stat-card{
      background:var(--pill);border-radius:10px;padding:16px;
      border:1px solid var(--border-color);text-align:center;
    }

    .stat-card .stat-value{
      font-size:28px;font-weight:700;color:var(--primary-color);
      line-height:1.2;
    }

    .stat-card .stat-label{
      font-size:12px;color:var(--text-light);
      text-transform:uppercase;letter-spacing:0.5px;
      font-weight:600;
    }

    .role-distribution{
      display:grid;grid-template-columns:repeat(4,1fr);
      gap:8px;
      margin:12px 0;
    }

    .role-card{
      background:white;border-radius:8px;padding:12px 8px;
      border:1px solid var(--border-color);text-align:center;
    }

    .role-card .role-count{
      font-size:22px;font-weight:700;color:var(--primary-color);
      line-height:1.2;
    }

    .role-card .role-name{
      font-size:11px;color:var(--text-light);margin-top:4px;
    }

    .table-container{
      flex:1;
      overflow:auto;
      border:1px solid var(--border-color);
      border-radius:8px;
      background:var(--card-bg);
      min-height:0;
      margin-top:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    
    th{
      background-color:var(--primary-color);
      color:white;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:10;
      white-space:nowrap;
      padding:10px 12px;
      text-align:left;
      font-size:12px;
    }
    
    td{
      padding:8px 12px;
      border-bottom:1px solid var(--border-color);
      white-space:nowrap;
    }
    
    td:first-child, th:first-child { padding-left:16px; }
    td:last-child, th:last-child { padding-right:16px; }
    
    tr:hover{background-color:var(--pill)}

    .status-badge{
      display:inline-block;padding:4px 10px;border-radius:16px;
      font-size:11px;font-weight:600;text-transform:uppercase;
    }

    .role-agent{background:rgba(99,171,143,0.15);color:var(--primary-color);border:1px solid rgba(99,171,143,0.3)}
    .role-supervisor{background:rgba(255,193,7,0.15);color:#d39e00;border:1px solid rgba(255,193,7,0.3)}
    .role-admin{background:rgba(220,53,69,0.15);color:var(--danger);border:1px solid rgba(220,53,69,0.3)}
    .role-other{background:rgba(108,117,125,0.15);color:var(--text-light);border:1px solid rgba(108,117,125,0.3)}

    .search-filter-bar{
      display:flex;
      gap:10px;
      margin-bottom:12px;
      flex-shrink:0;
    }
    
    .search-filter-bar input{
      flex:2;
      padding:8px 12px;
    }
    
    .search-filter-bar select{
      flex:1;
      padding:8px 12px;
    }
    
    .search-filter-bar .stats-info{
      display:flex;
      align-items:center;
      padding:0 12px;
      background:var(--filter-bg);
      border-radius:6px;
      font-size:12px;
      color:var(--text-light);
      white-space:nowrap;
    }

    .loading-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);display:flex;
      flex-direction:column;justify-content:center;align-items:center;
      z-index:9999;display:none;
    }

    .loading-overlay.active{display:flex}
    .spinner{
      width:50px;height:50px;border:4px solid #f3f3f3;
      border-top:4px solid var(--primary-color);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:16px;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    .progress-container{
      width:100%;max-width:400px;margin:16px auto;
    }

    .progress-bar{
      height:8px;background:var(--light-bg);border-radius:4px;
      overflow:hidden;
    }

    .progress-fill{
      height:100%;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      border-radius:4px;transition:width 0.3s ease;
      width:0%;
    }

    .last-login-status{font-size:11px;}
    .login-never{color:var(--danger);}
    .login-recent{color:var(--success);}
    .login-old{color:var(--warning);}

    .tabs{
      display:flex;
      border-bottom:2px solid var(--border-color);
      background:white;
      border-radius:10px 10px 0 0;
      flex-shrink:0;
    }

    .tab{
      padding:12px 20px;
      background:none;
      border:none;
      border-bottom:2px solid transparent;
      font-size:14px;
      font-weight:600;
      color:var(--text-light);
      cursor:pointer;
      transition:all 0.3s;
      flex:1;
      text-align:center;
    }

    .tab:hover{color:var(--primary-color)}
    .tab.active{
      color:var(--primary-color);
      border-bottom-color:var(--primary-color);
      background:rgba(99,171,143,0.05);
    }

    .tab-content{
      display:none;
      flex:1;
      min-height:0;
      overflow:hidden;
    }
    
    .tab-content.active{
      display:flex;
      flex-direction:column;
    }

    .action-buttons{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .action-buttons button{
      flex:1;
      padding:10px;
    }

    .export-actions {
      display:flex;
      gap:6px;
    }

    .summary-box {
      background:var(--pill);
      padding:12px;
      border-radius:8px;
      font-size:12px;
      line-height:1.5;
    }
  </style>
</head>
<body>
  <div id="authContainer" style="display:none;">
    <div class="container" style="max-width:450px;margin:100px auto;">
      <div class="card">
        <h3 style="margin-top:0;">üîê JLA Group Authentication</h3>
        <div style="text-align:center;margin-bottom:16px;">
          <span class="jla-badge">JLA GROUP</span>
        </div>
        <div class="auto-auth-message" style="text-align:center;padding:30px;">
          <div class="spinner" style="width:35px;height:35px;border-width:3px;margin:0 auto;"></div>
          <p style="margin-top:16px;font-size:14px;color:var(--text-light);">Connecting to JLA Group...</p>
          <p style="font-size:12px;color:var(--text-light);" id="authDebugInfo"></p>
        </div>
        <button id="btnForceAuth" class="btn btn-auth btn-block" style="display:none;">üîë Force Authentication</button>
      </div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <div id="mainContent" style="display:none;height:100vh;overflow:hidden;">
    <div class="container">
      <header>
        <h1>
          üë• JLA Group - User Manager 
          <span class="jla-badge">JLA</span>
        </h1>
        <div class="subtitle">View JLA Group users, roles, and permissions</div>
      </header>

      <div class="main-grid">
        <div class="left-column">
          <div class="card">
            <h2>üîå JLA Connection</h2>
            
            <div class="region-selector">
              <select id="regionSelect">
                <option value="eu-west-2" selected>üá¨üáß London (euw2.pure.cloud)</option>
              </select>
              <button id="btnSwitchRegion" class="btn-small">Connect</button>
            </div>
            
            <div style="background:var(--pill);padding:10px;border-radius:6px;margin-bottom:16px;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:20px;">üè¢</span>
                <div>
                  <div style="font-weight:600;font-size:14px;">JLA Group</div>
                  <div style="font-size:11px;color:var(--text-light);">ID: cd8f1ea1-d322...</div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Environment</label>
              <input type="text" id="envDisplay" value="London (euw2.pure.cloud)" readonly style="background:var(--filter-bg);font-size:13px;">
            </div>
            
            <div class="form-group">
              <label>Status</label>
              <div style="display:flex;align-items:center;gap:8px;">
                <div id="statusIndicator" style="width:12px;height:12px;border-radius:50%;background:#6c757d;"></div>
                <span id="statusText" style="font-size:13px;">Not Connected</span>
              </div>
            </div>

            <div id="tokenInfo" class="token-info">
              <div class="token-label">üîë Token Status</div>
              <div id="tokenStatus"></div>
              <div id="tokenExpiry" style="font-size:11px;"></div>
              <div class="token-value" id="tokenPreview"></div>
            </div>
            
            <div class="action-buttons">
              <button id="btnDisconnect" style="background:var(--danger);">
                <span>üö™ Disconnect</span>
              </button>
              <button id="btnReauth" style="background:var(--warning);color:var(--text-color);">
                <span>üîÑ Reconnect</span>
              </button>
            </div>
          </div>

          <div class="card">
            <h2>üìä JLA Statistics</h2>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="statTotalUsers">0</div>
                <div class="stat-label">Total Users</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="statActiveUsers">0</div>
                <div class="stat-label">With Login</div>
              </div>
            </div>

            <div class="role-distribution">
              <div class="role-card">
                <div class="role-count" id="statAgents">0</div>
                <div class="role-name">Agents</div>
              </div>
              <div class="role-card">
                <div class="role-count" id="statSupervisors">0</div>
                <div class="role-name">Supervisors</div>
              </div>
              <div class="role-card">
                <div class="role-count" id="statAdmins">0</div>
                <div class="role-name">Admins</div>
              </div>
              <div class="role-card">
                <div class="role-count" id="statOthers">0</div>
                <div class="role-name">Other</div>
              </div>
            </div>

            <div class="summary-box" id="totalRolesSummary">
              Click Load Users to fetch data
            </div>
          </div>

          <div class="card">
            <h2>‚ö° Actions</h2>
            <button id="btnFetchUsers" class="btn btn-success btn-block" disabled>
              <span>üîÑ Load JLA Users</span>
            </button>
            <div style="height:8px;"></div>
            <button id="btnReset" class="btn btn-block" style="background:var(--danger);">
              <span>üîÑ Reset Session</span>
            </button>
            <div style="margin-top:12px;font-size:11px;color:var(--text-light);text-align:center;">
              Last updated: <span id="lastUpdated">Never</span>
            </div>
          </div>
        </div>

        <div class="right-column">
          <div class="tabs">
            <button class="tab active" data-tab="users">üë• JLA Users</button>
            <button class="tab" data-tab="roles">üîë JLA Roles</button>
            <button class="tab" data-tab="logs">üìù Logs</button>
          </div>

          <div id="tab-users" class="tab-content active">
            <div class="card fill-height">
              <h2>
                üë• User List
                <div class="export-actions">
                  <button id="btnExportUsersTab" class="btn-export btn-small" disabled>
                    <span>üì• Export Users</span>
                  </button>
                </div>
              </h2>
              
              <div class="search-filter-bar">
                <input type="text" id="userSearch" placeholder="üîç Search by name, email, team, role...">
                <select id="userFilter">
                  <option value="all">All Users</option>
                  <option value="agent">Agents Only</option>
                  <option value="supervisor">Supervisors Only</option>
                  <option value="admin">Admins Only</option>
                  <option value="other">Other Roles</option>
                  <option value="hasLogin">Has Logged In</option>
                  <option value="noLogin">Never Logged In</option>
                </select>
                <div class="stats-info">
                  <span id="visibleCount">0</span>/<span id="totalCount">0</span>
                </div>
              </div>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Team/Group</th>
                      <th>Role Type</th>
                      <th>Roles</th>
                      <th>Last Login</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="usersTableBody">
                    <tr><td colspan="7" style="text-align:center;padding:48px;color:var(--text-light);">
                      Click "Load JLA Users" to fetch data
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="tab-roles" class="tab-content">
            <div class="card fill-height">
              <h2>
                üîë Role Distribution
                <div class="export-actions">
                  <button id="btnExportRolesTab" class="btn-export btn-small" disabled>
                    <span>üì• Export Roles</span>
                  </button>
                </div>
              </h2>
              
              <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
                <div class="stat-card">
                  <div class="stat-value" id="statUniqueRoles">0</div>
                  <div class="stat-label">Unique Roles</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="statAvgRoles">0</div>
                  <div class="stat-label">Avg Roles/User</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="statMultiRole">0</div>
                  <div class="stat-label">Multi-Role</div>
                </div>
              </div>

              <div style="margin-top:12px;flex:1;min-height:0;display:flex;flex-direction:column;">
                <h3 style="margin:0 0 8px 0;font-size:14px;">üìã All Roles</h3>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Role Name</th>
                        <th>User Count</th>
                        <th>Percentage</th>
                        <th>Sample Users</th>
                      </tr>
                    </thead>
                    <tbody id="rolesTableBody">
                      <tr><td colspan="4" style="text-align:center;padding:48px;">Load JLA users to see role data</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-logs" class="tab-content">
            <div class="card fill-height">
              <h2>
                üìù System Logs
                <div class="export-actions">
                  <button id="btnExportLogsTab" class="btn-export btn-small">
                    <span>üì• Export Logs</span>
                  </button>
                </div>
              </h2>

              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th width="100">Time</th>
                      <th width="80">Level</th>
                      <th>Message</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr><td colspan="4" style="text-align:center;padding:24px;">JLA Manager initialised</td></tr>
                  </tbody>
                </table>
              </div>
              
              <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
                <button id="btnClearLogs" class="btn-small">Clear</button>
                <button id="btnCopyLogs" class="btn-small">Copy to Clipboard</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:18px;font-weight:600;margin-bottom:8px;">Loading JLA Users...</div>
    <div id="loadingSubtext" style="font-size:13px;color:var(--text-light);text-align:center;max-width:400px;"></div>
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="loadingProgressFill"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== JLA CONFIGURATION ====================
    const JLA_CLIENT_ID = 'cd8f1ea1-d322-4b0c-9d0c-bc9aecd13aad';
    const JLA_REGION = 'eu-west-2';
    
    let CLIENT_ID = JLA_CLIENT_ID;
    
    // Update this to your new app's URL
    const REDIRECT_URI = 'https://gmcglynn88.github.io/ProfileManagement/';
    
    const ENVIRONMENTS = {
      'eu-west-2': { 
        name: 'üá¨üáß London - euw2.pure.cloud', 
        api: 'https://api.euw2.pure.cloud', 
        login: 'https://login.euw2.pure.cloud' 
      }
    };

    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_jla_environment',
      ENV_REGION: 'gc_jla_env_region',
      TOKEN: 'gc_jla_token',
      TOKEN_EXPIRY: 'gc_jla_token_expiry',
      REFRESH_TOKEN: 'gc_jla_refresh_token',
      SELECTED_REGION: 'gc_jla_selected_region'
    };

    let CURRENT_CONFIG = {
      environment: ENVIRONMENTS[JLA_REGION].api,
      environmentRegion: JLA_REGION,
      token: null,
      tokenExpiry: null,
      refreshToken: null
    };

    let appState = {
      isConnected: false,
      userData: [],
      currentTab: 'users',
      logs: [],
      rolesCache: new Map()
    };

    // ==================== DOM ELEMENTS ====================
    const el = {
      authContainer: document.getElementById('authContainer'),
      mainContent: document.getElementById('mainContent'),
      statusContainer: document.getElementById('statusContainer'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      
      btnDisconnect: document.getElementById('btnDisconnect'),
      btnReauth: document.getElementById('btnReauth'),
      btnSwitchRegion: document.getElementById('btnSwitchRegion'),
      btnFetchUsers: document.getElementById('btnFetchUsers'),
      btnReset: document.getElementById('btnReset'),
      btnClearLogs: document.getElementById('btnClearLogs'),
      btnCopyLogs: document.getElementById('btnCopyLogs'),
      btnForceAuth: document.getElementById('btnForceAuth'),
      
      // Export buttons
      btnExportUsersTab: document.getElementById('btnExportUsersTab'),
      btnExportRolesTab: document.getElementById('btnExportRolesTab'),
      btnExportLogsTab: document.getElementById('btnExportLogsTab'),
      
      regionSelect: document.getElementById('regionSelect'),
      envDisplay: document.getElementById('envDisplay'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      tokenInfo: document.getElementById('tokenInfo'),
      tokenStatus: document.getElementById('tokenStatus'),
      tokenExpiry: document.getElementById('tokenExpiry'),
      tokenPreview: document.getElementById('tokenPreview'),
      authDebugInfo: document.getElementById('authDebugInfo'),
      
      statTotalUsers: document.getElementById('statTotalUsers'),
      statActiveUsers: document.getElementById('statActiveUsers'),
      statAgents: document.getElementById('statAgents'),
      statSupervisors: document.getElementById('statSupervisors'),
      statAdmins: document.getElementById('statAdmins'),
      statOthers: document.getElementById('statOthers'),
      statUniqueRoles: document.getElementById('statUniqueRoles'),
      statAvgRoles: document.getElementById('statAvgRoles'),
      statMultiRole: document.getElementById('statMultiRole'),
      totalRolesSummary: document.getElementById('totalRolesSummary'),
      lastUpdated: document.getElementById('lastUpdated'),
      
      userSearch: document.getElementById('userSearch'),
      userFilter: document.getElementById('userFilter'),
      usersTableBody: document.getElementById('usersTableBody'),
      rolesTableBody: document.getElementById('rolesTableBody'),
      logsTableBody: document.getElementById('logsTableBody'),
      visibleCount: document.getElementById('visibleCount'),
      totalCount: document.getElementById('totalCount')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function formatDateForDisplay(dateString) {
      if (!dateString) return 'Never';
      const date = new Date(dateString);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays/7)} weeks ago`;
      
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }

    function getLoginStatusClass(lastLogin) {
      if (!lastLogin) return 'login-never';
      const date = new Date(lastLogin);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diffDays <= 7) return 'login-recent';
      if (diffDays <= 30) return 'login-old';
      return 'login-never';
    }

    function updateTokenDisplay() {
      if (CURRENT_CONFIG.token) {
        el.tokenInfo.classList.add('active');
        const expiryDate = new Date(CURRENT_CONFIG.tokenExpiry);
        const now = new Date();
        const expiresIn = Math.floor((CURRENT_CONFIG.tokenExpiry - now) / 1000 / 60);
        
        el.tokenStatus.innerHTML = expiresIn > 0 
          ? `‚úÖ Valid (expires in ${expiresIn} minutes)` 
          : `‚ùå Expired`;
        el.tokenExpiry.innerHTML = `Expires: ${expiryDate.toLocaleString()}`;
        el.tokenPreview.innerHTML = CURRENT_CONFIG.token.substring(0, 20) + '...';
      } else {
        el.tokenInfo.classList.remove('active');
      }
    }

    // ==================== AUTHENTICATION ====================
    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        const envRegion = localStorage.getItem(STORAGE_KEYS.ENV_REGION);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
        const storedRegion = localStorage.getItem(STORAGE_KEYS.SELECTED_REGION);

        logMessage('DEBUG', 'Loading stored JLA credentials', {
          hasToken: !!token,
          envRegion,
          storedRegion
        });

        if (storedRegion) {
          el.regionSelect.value = storedRegion;
        }

        if (token && tokenExpiry && environment && envRegion) {
          CURRENT_CONFIG = {
            token,
            tokenExpiry: parseInt(tokenExpiry, 10),
            environment,
            environmentRegion: envRegion,
            refreshToken
          };

          if (Date.now() < CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000)) {
            if (envRegion === JLA_REGION) {
              logMessage('SUCCESS', 'Valid JLA token found', `Expires: ${new Date(parseInt(tokenExpiry, 10)).toLocaleString()}`);
              return true;
            } else {
              logMessage('WARN', 'Token region mismatch', `Expected ${JLA_REGION}, got ${envRegion}`);
            }
          } else {
            logMessage('WARN', 'Stored JLA token expired');
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }
      return false;
    }

    function saveCredentials(token, expiresIn, environment, envRegion, refreshToken = null) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        CURRENT_CONFIG = { token, tokenExpiry, environment, environmentRegion: envRegion, refreshToken };
        
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, environment);
        localStorage.setItem(STORAGE_KEYS.ENV_REGION, envRegion);
        if (refreshToken) localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
        localStorage.setItem(STORAGE_KEYS.SELECTED_REGION, envRegion);
        
        updateTokenDisplay();
        logMessage('SUCCESS', 'JLA credentials saved', `Expires: ${new Date(tokenExpiry).toLocaleString()}`);
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.ENV_REGION);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        
        CURRENT_CONFIG.token = null;
        CURRENT_CONFIG.tokenExpiry = null;
        CURRENT_CONFIG.refreshToken = null;
        
        updateTokenDisplay();
        logMessage('INFO', 'JLA credentials cleared');
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    async function attemptTokenRefresh() {
      if (!CURRENT_CONFIG.refreshToken) {
        return false;
      }
      
      try {
        const loginUrl = ENVIRONMENTS[JLA_REGION].login;

        logMessage('INFO', 'Attempting JLA token refresh');

        const response = await fetch(`${loginUrl}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${JLA_CLIENT_ID}:`)
          },
          body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: CURRENT_CONFIG.refreshToken
          })
        });

        if (response.ok) {
          const data = await response.json();
          saveCredentials(data.access_token, data.expires_in, CURRENT_CONFIG.environment, 
                         JLA_REGION, data.refresh_token || CURRENT_CONFIG.refreshToken);
          logMessage('SUCCESS', 'JLA token refreshed');
          return true;
        } else {
          logMessage('ERROR', 'JLA token refresh failed', `Status: ${response.status}`);
          return false;
        }
      } catch (error) {
        logMessage('ERROR', 'JLA token refresh exception', error.message);
        return false;
      }
    }

    function parseTokenFromHash() {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return {};
      
      const params = new URLSearchParams(hash);
      return {
        token: params.get('access_token'),
        refreshToken: params.get('refresh_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in'),
        state: params.get('state')
      };
    }

    function authUrl() {
      const env = ENVIRONMENTS[JLA_REGION];
      
      const state = btoa(JSON.stringify({ 
        env: JLA_REGION,
        ts: Date.now(),
        client: 'JLA'
      }));
      
      return `${env.login}/oauth/authorize?client_id=${encodeURIComponent(JLA_CLIENT_ID)}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${encodeURIComponent(state)}`;
    }

    async function initAuth() {
      el.authContainer.style.display = 'block';
      
      const { token, refreshToken, error, errorDescription, expiresIn, state } = parseTokenFromHash();
      
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }

      if (token) {
        logMessage('INFO', 'JLA token found in URL', 'Processing authentication');
        
        if (saveCredentials(token, expiresIn || '3600', ENVIRONMENTS[JLA_REGION].api, JLA_REGION, refreshToken)) {
          logMessage('SUCCESS', 'JLA authentication successful');
          showStatusMessage('‚úÖ Connected to JLA Group', 'success');
          showMainApp();
          return;
        }
      }

      if (error) {
        logMessage('ERROR', 'JLA authentication failed', `${error}: ${errorDescription}`);
        showStatusMessage(`‚ùå Authentication failed: ${error}`, 'error');
        if (el.authDebugInfo) {
          el.authDebugInfo.innerHTML = `‚ùå Auth failed: ${error}`;
          el.btnForceAuth.style.display = 'block';
        }
        return;
      }

      const hasValidToken = loadStoredCredentials();
      if (hasValidToken) {
        logMessage('SUCCESS', 'Auto-authentication successful', 'Using stored JLA credentials');
        setTimeout(() => showMainApp(), 500);
        return;
      }

      const refreshSuccess = await attemptTokenRefresh();
      if (refreshSuccess) {
        logMessage('SUCCESS', 'JLA token refreshed');
        setTimeout(() => showMainApp(), 500);
        return;
      }

      logMessage('INFO', 'No valid JLA credentials found', 'Redirecting to authentication...');
      setTimeout(() => authenticate(), 1500);
    }

    function authenticate() {
      const authUrlValue = authUrl();
      logMessage('INFO', 'Redirecting to JLA authentication', `Client: JLA Group`);
      window.location.href = authUrlValue;
    }

    function checkTokenExpiry() {
      if (!CURRENT_CONFIG.token || !CURRENT_CONFIG.tokenExpiry) return false;
      return Date.now() < CURRENT_CONFIG.tokenExpiry - (5 * 60 * 1000);
    }

    function showMainApp() {
      el.authContainer.style.display = 'none';
      el.mainContent.style.display = 'block';
      el.envDisplay.value = ENVIRONMENTS[JLA_REGION].name;
      updateConnectionStatus(true, 'JLA Connected ‚úì');
      
      updateTokenDisplay();
      initializeApp();
    }

    function disconnect() {
      if (confirm('Disconnect from JLA Group? This will clear all stored credentials.')) {
        clearCredentials();
        appState.userData = [];
        appState.rolesCache.clear();
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        logMessage('INFO', 'Disconnected from JLA Group');
      }
    }

    function reauthenticate() {
      if (confirm('Reconnect to JLA Group? This will clear your current session.')) {
        clearCredentials();
        appState.userData = [];
        appState.rolesCache.clear();
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        setTimeout(() => authenticate(), 500);
      }
    }

    function switchRegion() {
      if (confirm('Connect to JLA Group?')) {
        clearCredentials();
        appState.userData = [];
        appState.rolesCache.clear();
        el.mainContent.style.display = 'none';
        el.authContainer.style.display = 'block';
        updateConnectionStatus(false, 'Not Connected');
        setTimeout(() => authenticate(), 500);
      }
    }

    function updateConnectionStatus(connected, message = '') {
      appState.isConnected = connected;
      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = message || 'JLA Connected ‚úì';
        el.statusText.style.color = 'var(--success)';
        el.btnFetchUsers.disabled = false;
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = message || 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnFetchUsers.disabled = true;
      }
      updateExportButtons();
    }

    function updateExportButtons() {
      const hasData = appState.userData && appState.userData.length > 0;
      el.btnExportUsersTab.disabled = !hasData;
      el.btnExportRolesTab.disabled = !hasData;
      // Logs export always enabled
    }

    // ==================== API FUNCTIONS ====================
    async function apiCall(path, options = {}) {
      if (!CURRENT_CONFIG.token) {
        throw new Error('Not authenticated - please reconnect to JLA');
      }
      
      if (!checkTokenExpiry()) {
        logMessage('WARN', 'JLA token expired, attempting refresh');
        const refreshSuccess = await attemptTokenRefresh();
        if (!refreshSuccess) {
          throw new Error('JLA token expired. Please reconnect.');
        }
      }
      
      const url = `${CURRENT_CONFIG.environment}${path}`;
      
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (response.status === 401 || response.status === 403) {
          logMessage('ERROR', `JLA authentication error ${response.status}`);
          
          const refreshSuccess = await attemptTokenRefresh();
          if (refreshSuccess) {
            const retryResponse = await fetch(url, {
              ...options,
              headers: {
                'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
                'Content-Type': 'application/json',
                ...options.headers
              }
            });
            if (retryResponse.ok) {
              return retryResponse.json();
            }
          }
          
          throw new Error('JLA authentication failed. Please reconnect.');
        }
        
        if (response.status === 429) {
          const retryAfter = response.headers.get('Retry-After') || 5;
          await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
          return apiCall(path, options);
        }
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        
        return response.json();
      } catch (error) {
        logMessage('ERROR', 'JLA API call failed', error.message);
        throw error;
      }
    }

    function detectUserRole(roles) {
      if (!roles || !Array.isArray(roles)) return 'other';
      const roleNames = roles.map(r => r.name.toLowerCase());
      
      const adminKeywords = ['admin', 'administrator', 'system administrator'];
      if (roleNames.some(role => adminKeywords.some(keyword => role.includes(keyword)))) return 'admin';
      
      const supervisorKeywords = ['supervisor', 'team lead', 'manager', 'director'];
      if (roleNames.some(role => supervisorKeywords.some(keyword => role.includes(keyword)))) return 'supervisor';
      
      const agentKeywords = ['agent', 'user', 'employee', 'representative'];
      if (roleNames.some(role => agentKeywords.some(keyword => role.includes(keyword)))) return 'agent';
      
      return 'other';
    }

    // ==================== MAIN FUNCTIONS ====================
    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details: details.toString() };
      appState.logs.unshift(logEntry);
      
      const row = document.createElement('tr');
      const levelIcon = level === 'ERROR' ? 'üî¥' : level === 'WARN' ? 'üü°' : level === 'SUCCESS' ? '‚úÖ' : 'üîµ';
      
      row.innerHTML = `<td>${timestamp}</td><td>${levelIcon} ${level}</td><td>${message}</td><td>${details}</td>`;
      
      if (el.logsTableBody.children[0]?.innerHTML.includes('JLA Manager initialised')) {
        el.logsTableBody.innerHTML = '';
      }
      el.logsTableBody.prepend(row);
      
      if (level === 'ERROR' || level === 'SUCCESS' || level === 'WARN') {
        showStatusMessage(message, level.toLowerCase());
      }
      console.log(`[JLA][${level}] ${message}`, details);
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : type === 'warn' ? 'var(--warning)' : 'var(--info)';
      
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `<span style="font-size:18px;">${icon}</span><div><div style="font-weight:600;">${message}</div><div style="font-size:11px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div></div>`;
      
      el.statusContainer.appendChild(msgDiv);
      
      setTimeout(() => msgDiv.remove(), 5000);
    }

    async function fetchUserData() {
      if (!appState.isConnected) {
        showStatusMessage('Please connect to JLA first', 'warn');
        return;
      }

      setLoading(true, 'Loading JLA Users', 'Fetching user list from Genesys Cloud...');
      updateLoadingProgress(10);

      try {
        let allUsers = [];
        let page = 1;
        const pageSize = 100;

        while (true) {
          updateLoadingProgress(10 + (page * 5));
          
          const usersData = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&expand=dateLastLogin,authorization,groups`);
          const users = usersData?.entities || [];
          allUsers = allUsers.concat(users);
          
          if (!usersData?.nextUri || users.length < pageSize) break;
          page++;
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        updateLoadingProgress(70);

        appState.userData = allUsers.map(user => {
          const teamName = user.groups && user.groups.length > 0 
            ? user.groups.map(g => g.name).join(', ') 
            : 'Unassigned';
          
          const roleNames = user.authorization?.roles 
            ? user.authorization.roles.map(r => r.name) 
            : [];
          
          const userType = detectUserRole(user.authorization?.roles);
          
          return {
            id: user.id,
            name: user.name || 'Unknown',
            email: user.email || 'No email',
            team: teamName,
            roles: roleNames,
            userType: userType,
            lastLogin: user.dateLastLogin,
            lastLoginDisplay: formatDateForDisplay(user.dateLastLogin),
            loginStatusClass: getLoginStatusClass(user.dateLastLogin),
            state: user.state || 'active'
          };
        });

        updateStats();
        renderUserTable();
        renderRolesTable();

        updateLoadingProgress(100);
        setLoading(false);
        
        updateExportButtons();
        el.lastUpdated.textContent = new Date().toLocaleString();
        
        logMessage('SUCCESS', 'JLA user data loaded', `${appState.userData.length} users`);
        showStatusMessage(`‚úÖ Loaded ${appState.userData.length} JLA users`, 'success');

      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch JLA users', error.message);
        showStatusMessage('‚ùå Failed to fetch JLA user data', 'error');
      }
    }

    function updateStats() {
      const users = appState.userData;
      
      el.statTotalUsers.textContent = users.length;
      el.totalCount.textContent = users.length;
      
      const usersWithLogin = users.filter(u => u.lastLogin).length;
      el.statActiveUsers.textContent = usersWithLogin;
      
      const agents = users.filter(u => u.userType === 'agent').length;
      const supervisors = users.filter(u => u.userType === 'supervisor').length;
      const admins = users.filter(u => u.userType === 'admin').length;
      const others = users.filter(u => u.userType === 'other').length;
      
      el.statAgents.textContent = agents;
      el.statSupervisors.textContent = supervisors;
      el.statAdmins.textContent = admins;
      el.statOthers.textContent = others;
      
      const roleFrequency = new Map();
      let totalRoles = 0;
      let multiRoleCount = 0;
      
      users.forEach(user => {
        if (user.roles && user.roles.length > 0) {
          totalRoles += user.roles.length;
          if (user.roles.length > 1) multiRoleCount++;
          
          user.roles.forEach(role => {
            roleFrequency.set(role, (roleFrequency.get(role) || 0) + 1);
          });
        }
      });
      
      appState.rolesCache = roleFrequency;
      
      el.statUniqueRoles.textContent = roleFrequency.size;
      el.statAvgRoles.textContent = users.length > 0 ? (totalRoles / users.length).toFixed(1) : '0';
      el.statMultiRole.textContent = multiRoleCount;
      
      const pctWithLogin = users.length > 0 ? Math.round((usersWithLogin / users.length) * 100) : 0;
      
      el.totalRolesSummary.innerHTML = `
        üìä ${usersWithLogin} users with login (${pctWithLogin}%)<br>
        üîë ${totalRoles} total role assignments<br>
        üë• ${multiRoleCount} users have 2+ roles
      `;
    }

    function renderUserTable() {
      const tbody = el.usersTableBody;
      tbody.innerHTML = '';
      
      const searchTerm = el.userSearch.value.toLowerCase();
      const filterValue = el.userFilter.value;
      
      let usersToDisplay = [...appState.userData];

      if (filterValue !== 'all') {
        if (filterValue === 'agent') usersToDisplay = usersToDisplay.filter(u => u.userType === 'agent');
        else if (filterValue === 'supervisor') usersToDisplay = usersToDisplay.filter(u => u.userType === 'supervisor');
        else if (filterValue === 'admin') usersToDisplay = usersToDisplay.filter(u => u.userType === 'admin');
        else if (filterValue === 'other') usersToDisplay = usersToDisplay.filter(u => u.userType === 'other');
        else if (filterValue === 'hasLogin') usersToDisplay = usersToDisplay.filter(u => u.lastLogin);
        else if (filterValue === 'noLogin') usersToDisplay = usersToDisplay.filter(u => !u.lastLogin);
      }

      if (searchTerm) {
        usersToDisplay = usersToDisplay.filter(user =>
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.team && user.team.toLowerCase().includes(searchTerm)) ||
          (user.roles && user.roles.some(r => r.toLowerCase().includes(searchTerm)))
        );
      }

      el.visibleCount.textContent = usersToDisplay.length;

      if (usersToDisplay.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align:center;padding:32px;color:var(--text-light);">
          ${appState.userData.length === 0 ? 'Click "Load JLA Users" to fetch data' : 'No JLA users match your search'}
        </td>`;
        tbody.appendChild(row);
        return;
      }

      usersToDisplay.slice(0, 1000).forEach(user => {
        const row = document.createElement('tr');
        
        let roleTypeBadge = '';
        switch(user.userType) {
          case 'agent': roleTypeBadge = `<span class="status-badge role-agent">Agent</span>`; break;
          case 'supervisor': roleTypeBadge = `<span class="status-badge role-supervisor">Supervisor</span>`; break;
          case 'admin': roleTypeBadge = `<span class="status-badge role-admin">Admin</span>`; break;
          default: roleTypeBadge = `<span class="status-badge role-other">Other</span>`;
        }

        const rolesDisplay = user.roles && user.roles.length > 0
          ? user.roles.slice(0, 2).join(', ') + (user.roles.length > 2 ? ` +${user.roles.length-2}` : '')
          : 'No roles';

        row.innerHTML = `
          <td><strong>${user.name}</strong></td>
          <td>${user.email}</td>
          <td style="font-size:12px;">${user.team}</td>
          <td>${roleTypeBadge}</td>
          <td><span title="${user.roles ? user.roles.join('\n') : ''}">${rolesDisplay}</span></td>
          <td><span class="last-login-status ${user.loginStatusClass}">${user.lastLoginDisplay}</span></td>
          <td><span class="status-badge" style="background:rgba(99,171,143,0.1);">${user.state}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderRolesTable() {
      const tbody = el.rolesTableBody;
      tbody.innerHTML = '';
      
      if (appState.rolesCache.size === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="4" style="text-align:center;padding:32px;">Load JLA users to see role data</td>`;
        tbody.appendChild(row);
        return;
      }

      const totalUsers = appState.userData.length;
      const sortedRoles = Array.from(appState.rolesCache.entries())
        .sort((a, b) => b[1] - a[1]);

      sortedRoles.slice(0, 200).forEach(([roleName, count]) => {
        const percentage = ((count / totalUsers) * 100).toFixed(1);
        const row = document.createElement('tr');
        
        const sampleUsers = appState.userData
          .filter(u => u.roles && u.roles.includes(roleName))
          .slice(0, 3)
          .map(u => u.name)
          .join(', ');
        
        row.innerHTML = `
          <td><strong>${roleName}</strong></td>
          <td style="text-align:center;font-weight:600;">${count}</td>
          <td style="text-align:center;">${percentage}%</td>
          <td style="font-size:12px;color:var(--text-light);">${sampleUsers}${count > 3 ? '...' : ''}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // ==================== EXPORT FUNCTIONS ====================
    function exportUsers() {
      if (!appState.userData || appState.userData.length === 0) {
        showStatusMessage('No user data to export', 'warn');
        return;
      }

      let csv = 'JLA Group User Export\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Total Users: ${appState.userData.length}\n\n`;
      csv += 'Name,Email,Team,User Type,Roles,Last Login,State\n';

      appState.userData.forEach(user => {
        const roles = user.roles ? user.roles.join('; ') : '';
        const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never';
        csv += `"${user.name}","${user.email}","${user.team}","${user.userType}","${roles}","${lastLogin}","${user.state}"\n`;
      });

      downloadCSV(csv, `jla_users_${new Date().toISOString().split('T')[0]}.csv`);
      logMessage('SUCCESS', 'JLA users exported', `${appState.userData.length} users`);
    }

    function exportRoles() {
      if (!appState.rolesCache || appState.rolesCache.size === 0) {
        showStatusMessage('No role data to export', 'warn');
        return;
      }

      let csv = 'JLA Group Role Export\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Total Users: ${appState.userData.length}\n\n`;
      csv += 'Role Name,User Count,Percentage,Sample Users\n';

      const sortedRoles = Array.from(appState.rolesCache.entries())
        .sort((a, b) => b[1] - a[1]);

      sortedRoles.forEach(([roleName, count]) => {
        const percentage = ((count / appState.userData.length) * 100).toFixed(1);
        const sampleUsers = appState.userData
          .filter(u => u.roles && u.roles.includes(roleName))
          .slice(0, 3)
          .map(u => u.name)
          .join('; ');
        
        csv += `"${roleName}",${count},${percentage}%,"${sampleUsers}"\n`;
      });

      downloadCSV(csv, `jla_roles_${new Date().toISOString().split('T')[0]}.csv`);
      logMessage('SUCCESS', 'JLA roles exported', `${sortedRoles.length} roles`);
    }

    function exportLogs() {
      if (!appState.logs || appState.logs.length === 0) {
        showStatusMessage('No logs to export', 'warn');
        return;
      }

      let csv = 'JLA Group System Logs\n';
      csv += `Generated: ${new Date().toLocaleString()}\n\n`;
      csv += 'Time,Level,Message,Details\n';

      appState.logs.forEach(log => {
        csv += `"${log.timestamp}","${log.level}","${log.message}","${log.details}"\n`;
      });

      downloadCSV(csv, `jla_logs_${new Date().toISOString().split('T')[0]}.csv`);
      logMessage('SUCCESS', 'Logs exported', `${appState.logs.length} entries`);
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showStatusMessage(`‚úÖ Exported to ${filename}`, 'success');
    }

    function resetApplication() {
      if (confirm('Reset JLA session? This will clear all user data.')) {
        appState.userData = [];
        appState.rolesCache.clear();
        updateStats();
        renderUserTable();
        renderRolesTable();
        updateExportButtons();
        logMessage('INFO', 'JLA session reset');
      }
    }

    function initializeApp() {
      logMessage('INFO', 'JLA Manager initialised');
      
      el.btnDisconnect.addEventListener('click', disconnect);
      el.btnReauth.addEventListener('click', reauthenticate);
      el.btnSwitchRegion.addEventListener('click', switchRegion);
      el.btnFetchUsers.addEventListener('click', fetchUserData);
      el.btnReset.addEventListener('click', resetApplication);
      el.btnForceAuth.addEventListener('click', () => {
        el.btnForceAuth.style.display = 'none';
        authenticate();
      });

      // Export buttons
      el.btnExportUsersTab.addEventListener('click', exportUsers);
      el.btnExportRolesTab.addEventListener('click', exportRoles);
      el.btnExportLogsTab.addEventListener('click', exportLogs);

      el.userSearch.addEventListener('input', renderUserTable);
      el.userFilter.addEventListener('change', renderUserTable);

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          appState.currentTab = tabId;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `tab-${tabId}`) content.classList.add('active');
          });
        });
      });

      el.btnClearLogs.addEventListener('click', () => {
        el.logsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;">Logs cleared</td></tr>';
        appState.logs = [];
      });

      el.btnCopyLogs.addEventListener('click', () => {
        const logText = appState.logs.map(log =>
          `${log.timestamp} [${log.level}] ${log.message} ${log.details}`
        ).join('\n');
        navigator.clipboard.writeText(logText);
        showStatusMessage('Logs copied to clipboard', 'success');
      });
    }

    document.addEventListener('DOMContentLoaded', initAuth);
  </script>
</body>
</html>
